// Copyright 2016 Google Inc. All rights reserved.
//
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE file or at
// https://developers.google.com/open-source/licenses/bsd

#include <absl/log/log.h>
#include <gtest/gtest.h>
#include <functional>

#include "packager/media/base/text_sample.h"
#include "packager/media/base/text_stream_info.h"
#include "packager/media/formats/mp2t/es_parser_teletext.h"

namespace shaka {
namespace media {
namespace mp2t {

namespace {

const uint8_t DESCRIPTOR[] = {0x56, 0x0a, 0x63, 0x61, 0x74, 0x09,
                              0x00, 0x63, 0x61, 0x74, 0x10, 0x88};

const uint8_t PES_283413[] = {
    0x10, 0x02, 0x2c, 0xe7, 0xe4, 0x92, 0x85, 0x80, 0xfe, 0x6b, 0x97, 0xce,
    0x97, 0x2f, 0xa7, 0xce, 0x40, 0xfe, 0x0b, 0xfb, 0x46, 0x37, 0x97, 0xc7,
    0xc1, 0x04, 0xfe, 0x32, 0x86, 0x04, 0x43, 0xf7, 0x2f, 0x97, 0xe6, 0x86,
    0x61, 0xfe, 0x05, 0x76, 0x26, 0xa7, 0x1f, 0x04, 0x2a, 0x6b, 0xc2, 0x03,
    0x2c, 0xe8, 0xe4, 0xa8, 0xa8, 0x0b, 0x0b, 0xa8, 0x0b, 0xa8, 0x0b, 0xf4,
    0xd9, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x23, 0xc7, 0x75, 0x8c, 0x1c, 0x04, 0x04,
    0x04, 0x8c, 0x8c, 0x8c, 0x04, 0x8c, 0x6d, 0x5d, 0x0d, 0x03, 0x2c, 0xe9,
    0xe4, 0xa8, 0xa8, 0x0b, 0x0b, 0xa8, 0x0b, 0xa8, 0x0b, 0xf4, 0xd9, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x23, 0xc7, 0x75, 0x8c, 0x1c, 0x04, 0x04, 0x04, 0x8c,
    0x8c, 0x8c, 0x04, 0x8c, 0x6d, 0x5d, 0x0d, 0x03, 0x2c, 0xea, 0xe4, 0xa8,
    0xa8, 0x0b, 0x0b, 0xa8, 0x0b, 0xa8, 0x0b, 0xf4, 0xd9, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x23, 0xc7, 0x75, 0x8c, 0x1c, 0x04, 0x04, 0x04, 0x8c, 0x8c, 0x8c,
    0x04, 0x8c, 0x6d, 0x5d, 0x0d, 0x03, 0x2c, 0xc7, 0xe4, 0xa8, 0x6d, 0xa8,
    0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff,
    0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff,
    0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff,
    0xb7, 0xc0, 0x00, 0x03, 0x2c, 0xc8, 0xe4, 0x0b, 0x6d, 0xa8, 0x57, 0x57,
    0x57, 0xf4, 0x57, 0x7a, 0x57, 0x57, 0x57, 0xf4, 0x57, 0x7a, 0x57, 0x57,
    0x57, 0xf4, 0x57, 0x7a, 0x57, 0x57, 0x57, 0xf4, 0x57, 0x7a, 0x57, 0x57,
    0x57, 0xf4, 0x57, 0x7a, 0x57, 0x57, 0x57, 0xf4, 0x57, 0x7a, 0xa8, 0xec,
    0x82, 0x03, 0x2c, 0xc9, 0xe4, 0xa8, 0xd9, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0xb0, 0xd0, 0xd0,
    0x43, 0xf7, 0x76, 0x04, 0x26, 0x97, 0x86, 0x85, 0x51, 0x51, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04};

const uint8_t PES_407876[] = {
    0x10, 0x02, 0x2c, 0xe7, 0xe4, 0x7a, 0x85, 0x80, 0xfe, 0x0b, 0x7f, 0xe6,
    0x75, 0xd5, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x61, 0xfe, 0x0b, 0x7f, 0xe6, 0x75, 0xb5, 0x03,
    0x2c, 0xe8, 0xe4, 0xa8, 0xa8, 0x0b, 0x0b, 0xa8, 0x0b, 0xa8, 0x0b, 0xf4,
    0xd9, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x23, 0xc7, 0x75, 0x8c, 0x1c, 0x04, 0x04,
    0x04, 0x04, 0x8c, 0x6d, 0x5d, 0x0d, 0xcd, 0x5d, 0x4c, 0x03, 0x2c, 0xe9,
    0xe4, 0xa8, 0xa8, 0x0b, 0x0b, 0xa8, 0x0b, 0xa8, 0x0b, 0xf4, 0xd9, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x23, 0xc7, 0x75, 0x8c, 0x1c, 0x04, 0x04, 0x04, 0x04,
    0x8c, 0x6d, 0x5d, 0x0d, 0xcd, 0x5d, 0x4c, 0x03, 0x2c, 0xea, 0xe4, 0xa8,
    0xa8, 0x0b, 0x0b, 0xa8, 0x0b, 0xa8, 0x0b, 0xf4, 0xd9, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x23, 0xc7, 0x75, 0x8c, 0x1c, 0x04, 0x04, 0x04, 0x04, 0x8c, 0x6d,
    0x5d, 0x0d, 0xcd, 0x5d, 0x4c, 0x03, 0x2c, 0xc7, 0xe4, 0xa8, 0x6d, 0xa8,
    0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff,
    0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff,
    0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff,
    0xf9, 0x2d, 0x00, 0x03, 0x2c, 0xc8, 0xe4, 0x0b, 0x6d, 0xa8, 0x57, 0x57,
    0x57, 0xf4, 0x57, 0x7a, 0x57, 0x57, 0x57, 0xf4, 0x57, 0x7a, 0x57, 0x57,
    0x57, 0xf4, 0x57, 0x7a, 0x57, 0x57, 0x57, 0xf4, 0x57, 0x7a, 0x57, 0x57,
    0x57, 0xf4, 0x57, 0x7a, 0x57, 0x57, 0x57, 0xf4, 0x57, 0x7a, 0xa8, 0x00,
    0x00, 0x02, 0x2c, 0xc9, 0xe4, 0x40, 0xa8, 0xa8, 0xa8, 0x40, 0x0b, 0xa8,
    0xa8, 0xa8, 0x31, 0x2a, 0x6b, 0xcd, 0x2a, 0xa2, 0x1a, 0x2a, 0xc1, 0x2a,
    0x6b, 0xcd, 0xe0, 0x8c, 0x0d, 0x0d, 0x04, 0x23, 0xc7, 0x75, 0x8c, 0x1c,
    0xc1, 0x04, 0x04, 0x04, 0x8c, 0x6d, 0x5d, 0x0d, 0xcd, 0x5d, 0x4c};

const uint8_t PES_8768632[] = {
    0x10, 0x02, 0x2c, 0xe7, 0xe4, 0x92, 0x0b, 0xc8, 0x34, 0x34, 0x34, 0x34,
    0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34,
    0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34,
    0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x02,
    0x2c, 0xe8, 0xe4, 0x92, 0xe3, 0x40, 0x73, 0xf7, 0x2f, 0xba, 0xc7, 0x97,
    0xa7, 0xce, 0x04, 0xa7, 0xce, 0x0e, 0xf7, 0x4f, 0x2f, 0x97, 0x6e, 0xa7,
    0xce, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75,
    0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x8c, 0xad, 0x0d, 0x02, 0x2c, 0xe9,
    0xe4, 0x31, 0x31, 0xc8, 0xb9, 0x01, 0xb0, 0x0b, 0x4f, 0xf7, 0xe6, 0x4f,
    0x86, 0xb6, 0x86, 0xc7, 0x97, 0x7a, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75,
    0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75,
    0x75, 0x75, 0x75, 0x75, 0xcd, 0x0d, 0x0d, 0x02, 0x2c, 0xea, 0xe4, 0x31,
    0xd9, 0xe0, 0xb9, 0x01, 0x04, 0x92, 0x76, 0x67, 0xf7, 0x4f, 0xb6, 0x86,
    0xc7, 0x97, 0x7a, 0x04, 0x2a, 0x6b, 0xc2, 0x75, 0x75, 0x75, 0x75, 0x75,
    0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75,
    0x75, 0x75, 0x4c, 0x1c, 0x0d, 0x02, 0x2c, 0xc7, 0xe4, 0x92, 0x85, 0x80,
    0xfe, 0x62, 0x75, 0xcb, 0x86, 0x37, 0x86, 0x04, 0xb6, 0x86, 0xce, 0x75,
    0x04, 0x40, 0xfe, 0x43, 0x7f, 0xce, 0x8f, 0xae, 0xa7, 0x2f, 0xc1, 0xfe,
    0x62, 0xae, 0x2f, 0x46, 0xf7, 0x37, 0x61, 0xfe, 0xa2, 0xce, 0x0e, 0xf7,
    0x4f, 0x2f, 0xce, 0x03, 0x2c, 0xc8, 0xe4, 0xa8, 0xa8, 0x0b, 0x0b, 0xa8,
    0x0b, 0xa8, 0x0b, 0xf4, 0xd9, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x23, 0xc7, 0x75,
    0x8c, 0x1c, 0x04, 0x04, 0x04, 0x97, 0x2f, 0xae, 0x37, 0x86, 0x4f, 0xce,
    0x75, 0x03, 0x2c, 0xc9, 0xe4, 0xa8, 0xa8, 0x0b, 0x0b, 0xa8, 0x0b, 0xa8,
    0x0b, 0xf4, 0xd9, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x23, 0xc7, 0x75, 0x8c, 0x1c,
    0x04, 0x04, 0x04, 0x97, 0x2f, 0xae, 0x37, 0x86, 0x4f, 0xce, 0x75};

const uint8_t PES_8773087[] = {
    0x10, 0x03, 0x2c, 0xe7, 0xe4, 0xa8, 0x6d, 0xa8, 0x2e, 0xfe, 0xff, 0x2e,
    0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e,
    0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e,
    0xfe, 0xff, 0x2e, 0xfe, 0xff, 0x2e, 0xfe, 0xff, 0xdc, 0x08, 0x00, 0x03,
    0x2c, 0xe8, 0xe4, 0x0b, 0x6d, 0xa8, 0x57, 0x57, 0x57, 0xf4, 0x57, 0x7a,
    0x57, 0x57, 0x57, 0xf4, 0x57, 0x7a, 0x57, 0x57, 0x57, 0xf4, 0x57, 0x7a,
    0x57, 0x57, 0x57, 0xf4, 0x57, 0x7a, 0x57, 0x57, 0x57, 0xf4, 0x57, 0x7a,
    0x57, 0x57, 0x57, 0xf4, 0x57, 0x7a, 0xa8, 0x25, 0xee, 0x03, 0x2c, 0xe9,
    0xe4, 0xa8, 0x31, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0xb0, 0xd0, 0xd0, 0xb5, 0xcb,
    0xba, 0xfd, 0x51, 0x51, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x03, 0x2c, 0xea, 0xe4, 0xa8,
    0xd9, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0xb0, 0xd0, 0xd0, 0xb5, 0xcb, 0xba, 0x75,
    0x51, 0x51, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x02, 0x2c, 0xc7, 0xe4, 0x92, 0xa8, 0x40,
    0x1c, 0x40, 0x0b, 0xa8, 0xa8, 0x92, 0xd9, 0x2a, 0x6b, 0xcd, 0x2a, 0xa2,
    0x1a, 0x2a, 0xc1, 0x2a, 0x6b, 0xcd, 0xe0, 0x4c, 0x6d, 0x8c, 0x04, 0x23,
    0xc7, 0x75, 0x8c, 0x1c, 0xc1, 0x04, 0x04, 0x2f, 0xae, 0x37, 0x86, 0x4f,
    0xce, 0x75, 0x75, 0x02, 0x2c, 0xc8, 0xe4, 0x92, 0xa8, 0x40, 0x1c, 0x40,
    0x0b, 0xa8, 0xa8, 0x92, 0xd9, 0x2a, 0x6b, 0xcd, 0x2a, 0xa2, 0x1a, 0x2a,
    0xc1, 0x2a, 0x6b, 0xcd, 0xe0, 0x4c, 0x6d, 0x8c, 0x04, 0x23, 0xc7, 0x75,
    0x8c, 0x1c, 0xc1, 0x04, 0x04, 0x2f, 0xae, 0x37, 0x86, 0x4f, 0xce, 0x75,
    0x75, 0x02, 0x2c, 0xc9, 0xe4, 0x92, 0xa8, 0x40, 0x1c, 0x40, 0x0b, 0xa8,
    0xa8, 0x92, 0xd9, 0x2a, 0x6b, 0xcd, 0x2a, 0xa2, 0x1a, 0x2a, 0xc1, 0x2a,
    0x6b, 0xcd, 0xe0, 0x4c, 0x6d, 0x8c, 0x04, 0x23, 0xc7, 0x75, 0x8c, 0x1c,
    0xc1, 0x04, 0x04, 0x2f, 0xae, 0x37, 0x86, 0x4f, 0xce, 0x75, 0x75};

const uint8_t PES_8937764[] = {
    0x10, 0x02, 0x2c, 0xe7, 0xe4, 0x31, 0xe3, 0x04, 0x61, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x86, 0xc7, 0x86, 0xce, 0x86,
    0xce, 0x15, 0x86, 0x94, 0x2f, 0x6e, 0xcd, 0x75, 0xc7, 0x86, 0x2f, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x02,
    0x2c, 0xe8, 0xe4, 0x92, 0x31, 0x04, 0x80, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x15, 0x86,
    0x94, 0xbc, 0x86, 0x4f, 0x4f, 0xf7, 0x6e, 0x86, 0x04, 0x02, 0x2c, 0xe9,
    0xe4, 0x31, 0x31, 0x80, 0xb9, 0x01, 0xb0, 0xa2, 0x37, 0x04, 0x2f, 0xa7,
    0xb6, 0x0e, 0xce, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75,
    0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75,
    0x75, 0x75, 0x75, 0x75, 0x8c, 0x6d, 0x0d, 0x02, 0x2c, 0xea, 0xe4, 0x31,
    0xd9, 0xe0, 0xb9, 0x01, 0x04, 0x05, 0x76, 0x26, 0xa7, 0x1f, 0x04, 0x4f,
    0x7f, 0x0e, 0x97, 0x26, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75,
    0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75, 0x75,
    0x75, 0x75, 0x4c, 0x1c, 0x4c, 0x02, 0x2c, 0xc7, 0xe4, 0x92, 0x85, 0x80,
    0xfe, 0x05, 0x76, 0x26, 0xa7, 0x1f, 0x40, 0xfe, 0x0b, 0x4f, 0xf7, 0xe6,
    0x4f, 0x86, 0xb6, 0x86, 0xc7, 0x97, 0x7a, 0xc1, 0xfe, 0xa2, 0xce, 0x0e,
    0xf7, 0x4f, 0x2f, 0xce, 0x61, 0xfe, 0x32, 0xf7, 0x2f, 0xa7, 0x4f, 0x97,
    0xa7, 0xce, 0x04, 0x03, 0x2c, 0xc8, 0xe4, 0xa8, 0xa8, 0x0b, 0x0b, 0xa8,
    0x0b, 0xa8, 0x0b, 0xf4, 0xd9, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x23, 0xc7, 0x75,
    0x8c, 0x1c, 0x04, 0x04, 0x04, 0x86, 0x4f, 0xce, 0x75, 0x75, 0x75, 0x8c,
    0x8c, 0x03, 0x2c, 0xc9, 0xe4, 0xa8, 0xa8, 0x0b, 0x0b, 0xa8, 0x0b, 0xa8,
    0x0b, 0xf4, 0xd9, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x23, 0xc7, 0x75, 0x8c, 0x1c,
    0x04, 0x04, 0x04, 0x86, 0x4f, 0xce, 0x75, 0x75, 0x75, 0x8c, 0x8c};

const uint32_t kPesPid = 123;

}  // namespace

class EsParserTeletextTest : public ::testing::Test {
 public:
  void OnNewStreamInfo(uint32_t pes_pid,
                       std::shared_ptr<StreamInfo> stream_info) {
    stream_info_ = stream_info;
  }
  void OnEmitTextSample(uint32_t pes_pid,
                        std::shared_ptr<TextSample> text_sample) {
    text_sample_ = text_sample;
  }

 protected:
  std::shared_ptr<StreamInfo> stream_info_;
  std::shared_ptr<TextSample> text_sample_;
};

TEST_F(EsParserTeletextTest, descriptor_substreams_has_index_888_language_cat) {
  auto on_new_stream = std::bind(&EsParserTeletextTest::OnNewStreamInfo, this,
                                 kPesPid, std::placeholders::_1);
  auto on_emit_text = std::bind(&EsParserTeletextTest::OnEmitTextSample, this,
                                kPesPid, std::placeholders::_1);

  std::unique_ptr<EsParserTeletext> es_parser_teletext(new EsParserTeletext(
      kPesPid, on_new_stream, on_emit_text, DESCRIPTOR, 12));

  const auto parse_result =
      es_parser_teletext->Parse(PES_283413, sizeof(PES_283413), 283413, 0);
  EXPECT_TRUE(parse_result);

  EXPECT_NE(nullptr, stream_info_.get());
  auto text_stream_info = static_cast<TextStreamInfo*>(stream_info_.get());
  auto& sub_streams = text_stream_info->sub_streams();

  EXPECT_EQ(2, sub_streams.size());
  auto sub_streams_itr = sub_streams.find(888);
  EXPECT_NE(sub_streams.end(), sub_streams_itr);
  EXPECT_EQ("cat", sub_streams_itr->second.language);
}

TEST_F(EsParserTeletextTest, pes_283413_line_emitted_on_next_pes) {
  auto on_new_stream = std::bind(&EsParserTeletextTest::OnNewStreamInfo, this,
                                 kPesPid, std::placeholders::_1);
  auto on_emit_text = std::bind(&EsParserTeletextTest::OnEmitTextSample, this,
                                kPesPid, std::placeholders::_1);

  std::unique_ptr<EsParserTeletext> es_parser_teletext(new EsParserTeletext(
      kPesPid, on_new_stream, on_emit_text, DESCRIPTOR, 12));

  auto parse_result =
      es_parser_teletext->Parse(PES_283413, sizeof(PES_283413), 283413, 0);
  EXPECT_TRUE(parse_result);

  parse_result =
      es_parser_teletext->Parse(PES_407876, sizeof(PES_407876), 407876, 0);
  EXPECT_TRUE(parse_result);

  EXPECT_NE(nullptr, text_sample_.get());
  EXPECT_EQ(283413, text_sample_->start_time());
  EXPECT_EQ(407876, text_sample_->EndTime());
  EXPECT_EQ("Bon dia!", text_sample_->body().body);
}

TEST_F(EsParserTeletextTest, multiple_lines_with_same_pts) {
  auto on_new_stream = std::bind(&EsParserTeletextTest::OnNewStreamInfo, this,
                                 kPesPid, std::placeholders::_1);
  auto on_emit_text = std::bind(&EsParserTeletextTest::OnEmitTextSample, this,
                                kPesPid, std::placeholders::_1);

  std::unique_ptr<EsParserTeletext> es_parser_teletext(new EsParserTeletext(
      kPesPid, on_new_stream, on_emit_text, DESCRIPTOR, 12));

  auto parse_result =
      es_parser_teletext->Parse(PES_8768632, sizeof(PES_8768632), 8768632, 0);
  EXPECT_TRUE(parse_result);

  parse_result =
      es_parser_teletext->Parse(PES_8773087, sizeof(PES_8773087), 8773087, 0);
  EXPECT_TRUE(parse_result);

  parse_result =
      es_parser_teletext->Parse(PES_8937764, sizeof(PES_8937764), 8937764, 0);
  EXPECT_TRUE(parse_result);

  EXPECT_NE(nullptr, text_sample_.get());
  EXPECT_EQ(8768632, text_sample_->start_time());
  EXPECT_EQ(8937764, text_sample_->EndTime());
  EXPECT_EQ(3, text_sample_->body().sub_fragments.size());
  EXPECT_EQ("-Sí?", text_sample_->body().sub_fragments[0].body);
  EXPECT_TRUE(text_sample_->body().sub_fragments[1].newline);
  EXPECT_EQ("-Sí.", text_sample_->body().sub_fragments[2].body);
}

}  // namespace mp2t
}  // namespace media
}  // namespace shaka
